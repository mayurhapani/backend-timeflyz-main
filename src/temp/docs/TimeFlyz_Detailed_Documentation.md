# TimeFlyz Documentation - Backend

## Authentication Module

### Login : POST /api/v1/auth/login

**Admin:**

- email id + password

**Customer:**

- email id / mobile number + password (only customer can use phone number)

**Process:**

- Check user is active or not deleted
- Check password by MD5
- Store cookies by backend
- Store token in local storage (by frontend)
- Token generated by using user's \_id and role (JWT)

### Logout : GET /api/v1/auth/logout

- Only can logout when user is authorized
- Remove cookies from backend
- Remove FCM token from database
- Need to remove token from local storage (by frontend)

### Forgot Password : POST /api/v1/auth/forgot-password

**Required fields:**

```
const { email, phone } = req.body; //only customer can use phone number
```

**Process:**

- Verify if there's already OTP in the database with user credential, then update new OTP
- If not, generate OTP and send via mobile number or email
- OTP stored in optModel with expiry of 10 minutes
- Note: Send OTP pending due to lack of credentials

### Verify OTP : POST /api/v1/auth/verify-otp

**Required fields:**

```
const { otp, email, phone } = req.body; //only customer can use phone number
```

**Process:**

- Get OTP from OTP model using email or phone number
- Check token expiry (10 min)
- After verifying OTP, delete it from database to clear duplication
- Send success in response

### Set Forgot Password : POST /api/v1/auth/set-forgot-password

**Required fields:**

```
const { email, password } = req.body; //only customer can use phone number
```

**Process:**

- Update password field in user document with encryption using MD5
- Send success response

### Reset Password : POST /api/v1/auth/reset-password

**Required fields:**

```
const { token, oldPassword, newPassword } = req.body; // add confirm password from frontend side
```

**Process:**

- Check old password using salt and MD5
- If old password matches, take new password, encrypt it and store in database
- Send response

### Send Verification Email : POST /api/v1/auth/sendEmailVerificationMail

**Process:**

- Take token from header (pass token in header from frontend)
- Split the user token from the frontend token
- Attach token with verification link
- Send link using "sendgrid" (send email configuration pending)
- Send success response

### Verify Email : POST /api/v1/auth/verify-email

**Required fields:**

```
const { token } = req.query;
```

**Process:**

- Get token from query
- Decode token with JWT
- Find user from the decoded data
- Update status of "isEmailVerified" in database
- Send success response

## Guest User Module

### Create Guest User : POST /api/v1/guest/create

**Process:**

- Use uuidv4 to create unique ID for every guest user
- Add new guest uuid, role = "guest", type = "guest" in the payload
- Create token using this payload (token expires in 24h)
- Note: Guest user data will not be stored in database, it is only for visit purpose and searching for hotels

## Hotel Module

### Create Hotel : POST /api/v1/hotel/create

**Required fields:**

```
const {
  name,
  description,
  address,
  city,
  state,
  country,
  pincode,
  location,
  images,
  amenitiesId,
  adminId,
  Managers, //if manager already created
  contactNumber,
  email,
  website,
  rating,
  totalReviews,
} = req.body;
```

**Process:**

- Only Admin/ChainAdmin and SuperAdmin can create Hotel
- Chain admin can add multiple hotels but admin creates only one hotel
- Check if hotel exists with same name and with same pincode
- Upload images of hotel to S3 cloud
- Send success response
- Note: Image upload pending

### Get Hotel By Id : GET /api/v1/hotel/get/:id

**Required fields:**

- Hotel Id (in req.params.id)
- Note: Only super admin can see inactive or deleted hotels

### Delete Hotel By Id : DELETE /api/v1/hotel/delete/:ids

**Required fields:**

- Hotel Id (in req.params.ids)
- Can select multiple ids to delete multiple hotels
- Only super admin can delete hotel

### Update Hotel By Id : PUT /api/v1/hotel/update/:id

**Required fields:**

```
const {
  name,
  description,
  address,
  city,
  state,
  country,
  pincode,
  location,
  images,
  amenitiesId,
  adminId,
  managers,
  contactNumber,
  email,
  website,
  isActive,
  isDeleted,
} = req.body;
```

- Hotel Id (in req.params.ids)

**Process:**

- Only super admin can update inactive or deleted hotel
- Check if new email is already taken
- When user tries to delete account, it will not be deleted but just update isDeleted field
- Only super admin can delete user profile

### Search Hotel / Get All Hotels : GET /api/v1/hotel/getAll

**Required fields:**

```
const { search = "", lat, lng, distance, adminId, customerId, amenitiesId } = req.query;
const page = parseInt(req.query.page) || 1;
const limit = parseInt(req.query.limit);
```

**Process:**

- Can be used without Auth (using guest user) or with login
- User can search hotel by distance, hotel name, city, country, email, contact number
- User can search hotel by Amenities too (pass amenitiesId from frontend)
- Only super admin can see inactive or deleted hotels
- Super Admin can search hotel by AdminIds too (pass adminId from frontend)
- Only super admin and admin can search hotel by admin id

## Hotel Amenities Module (only super admin)

### Create Hotel Amenities : POST /api/v1/hotelAmenities/create

**Required fields:**

```
const { name } = req.body;
```

**Process:**

- Check if hotel amenity already exists with same name

### Get Hotel Amenities By Id : GET /api/v1/hotelAmenities/get/:id

**Required fields:**

- Hotel Id (in req.params.id)
- Only super admin can see inactive or deleted hotel amenities

### Delete Hotel Amenities By Ids : DELETE /api/v1/hotelAmenities/delete/:ids

**Required fields:**

- Hotel Id (in req.params.ids)
- Can select multiple ids to delete multiple hotel amenities
- Only super admin can delete hotel amenity

### Update Hotel Amenities By Id : PUT /api/v1/hotelAmenities/update/:id

**Required fields:**

```
const { name } = req.body;
```

- Hotel Id (in req.params.id)

**Process:**

- Super admin can change names
- Check if hotel amenity already exists with same name

### Get Hotel Amenities : GET /api/v1/hotelAmenities/getAll

**Required fields:**

```
const { search = "", hotelId } = req.query;
const page = parseInt(req.query.page) || 1;
const limit = parseInt(req.query.limit);
```

- Only super admin can see inactive or deleted hotels

## User Module

### Create User : POST /api/v1/user/create

**Required fields:**

```
const {
  name,
  email,
  Password, //confirm password field add in frontend
  role, // enum:["superAdmin", "admin", "manager", "supportAgent"]
  phone,
  profilePic,
  hotelId,
  isActive,
  isChainAdmin,
} = req.body;
```

**Process:**

- Only super admin can create "admins" and "support agents"
- Admin can create only "managers"
- Password min length 8 must use validation from frontend
- Password must include: 1 number, 1 uppercase, 1 lowercase, 1 special character
- Password encrypted by MD5
- If user is not admin or super admin, they cannot create new user
- If user is chain admin, they can add multiple hotels
- If user role is not chain admin or a manager, they can add only one hotel
- Send new user data in response without password

### Get User By Id : GET /api/v1/user/get/:id

**Required fields:**

- User Id (in req.params.id)
- Only super admin can see inactive or deleted user

### Delete User By Ids : DELETE /api/v1/user/delete/:ids

**Required fields:**

- User Ids (in req.params.ids)
- Can select multiple ids to delete multiple users
- Only super admin can delete user

### Update User By Id : PUT /api/v1/user/update/:id

**Required fields:**

```
const {
  name,
  email,
  role,
  phone,
  profilePic,
  hotelId,
  isActive,
  isDeleted,
  supportAgentStatus,
  isChainAdmin
} = req.body;
```

- UserId (in req.params.id)

**Process:**

- Check if email is being updated and if it's already taken
- If user is chain admin, they can add multiple hotels
- If user is not chain admin or a manager, they can add only one hotel
- Remove undefined fields
- Update user
- Send success response with updated user data
- When user tries to delete account, it will not be deleted but just update isDeleted field
- Only super admin can delete user profile

### Get All User : GET /api/v1/user/getAll

**Required fields:**

```
const { search = "", role, isActive, hotelId, customerId } = req.query;
const page = parseInt(req.query.page) || 1;
const limit = parseInt(req.query.limit);
```

**Process:**

- Find result length
- Get result with pagination using "limit" and "skip" without password field
- Search can be possible with multiple hotel ids and multiple customer ids
- Only super admin can see inactive users and deleted users
- Send success response with all user data

## Common Routes

### Temp File Upload : POST /api/v1/common/tempFileUpload

**Process:**

- This route stores image/file in temporary location on S3 server in temp folder
- Uses S3 configuration for storing data
- Will transfer file to folder later when every process is completed
- Uses "multer-s3" and "@aws-sdk/client-s3"

## Customer Module

### Create Customer: POST /api/v1/customer/create

**Required fields:**

```
const { name, email, password, phone, profilePic } = req.body;
```

**Process:**

- Password min length 8 must use validation from frontend
- Password must include: 1 number, 1 uppercase, 1 lowercase, 1 special character
- Password encrypted by MD5
- Check if customer already exists
- Create new customer with new data
- Send new customer data in response without password

### Get Customer By Id : GET /api/v1/customer/get/:id

**Required fields:**

- Customer Id (in req.params.id)
- Only super admin can see inactive or deleted customers

### Delete Customer By Id : DELETE /api/v1/customer/delete/:id

**Required fields:**

- Customer Id (in req.params.id)
- Only super admin can delete customer profile

### Update Customer By Id : PUT /api/v1/customer/update/:id

**Required fields:**

```
const { name, email, phone, profilePic, isActive, isDeleted } = req.body;
```

- Customer Id (in req.params.id)

**Process:**

- Check if email is being updated and if it's already taken
- Only admin can update deleted or inactive user
- Remove undefined fields
- Update Customer
- Send success response with updated Customer data
- When customer tries to delete account, it will not be deleted but just update isDeleted field
- Only super admin can delete user profile

### Get All Customer : GET /api/v1/customer/getAll

**Required fields:**

```
const { search = "", hotelId, isActive } = req.query;
const page = parseInt(req.query.page) || 1;
const limit = parseInt(req.query.limit);
```

**Process:**

- Get all customers by multiple hotelId (if hotelId exists)
- Find result length
- Get result with pagination using "limit" and "skip" without password field
- Send success response with all customers data
- Search can be possible with multiple hotel ids and multiple customer ids
- Only super admin can see inactive users and deleted users

### Add Or Remove From Favorites : GET /api/v1/customer/addToFavorites/:id

**Required fields:**

```
const { hotelId } = req.body;
const customerId = req.params.id;
```

**Process:**

- Check in user favorites list if hotel is already in user favorites list
- If exists, remove hotel id; if not exists, add hotel id to users favorite list
- Count number of favorite hotels
- Send success response with count and hotel ID list

## Reviews Module

### Create Review : POST /api/v1/review/create

**Required fields:**

```
const { customerId, hotelId, rating, comment } = req.body;
```

- Rating must be between 1-5

### Get Review By Id : GET /api/v1/review/get/:id

**Required fields:**

- Hotel Id (in req.params.id)
- Only super admin can see inactive or deleted review

### Delete Review By Ids : DELETE /api/v1/review/delete/:ids

**Required fields:**

- Review Ids (in req.params.ids)
- Can select multiple ids to delete multiple reviews
- Only super admin can delete reviews

### Update Review By Id : PUT /api/v1/review/update/:id

**Required fields:**

```
const { rating, comment, replyByHotel, isActive, isDeleted } = req.body;
```

- Hotel Id (in req.params.id)

**Process:**

- Only admin can update deleted or inactive reviews
- Clear undefined values from payload
- Update review
- Send success response

### Get All Reviews : GET /api/v1/review/getAll

**Required fields:**

```
const { search = "", rating, startDate, endDate, hotelId, customerId } = req.query;
const page = parseInt(req.query.page) || 1;
const limit = parseInt(req.query.limit);
```

**Process:**

- Search can be possible with multiple hotel ids and multiple customer ids
- Only super admin can see inactive and deleted reviews

## Master Room Module

### Create Master Room: POST /api/v1/masterRoom/create

**Required fields:**

```
const { hotelId, masterRoomName, subRooms, fullDayPrice, description, images, capacity, amenities, isActive } = req.body;
```

**Process:**

- Check if master room already exists in hotel with same name
- Create master room
- Create sub rooms with given array of "subRooms"
- Upload Images of room
- Send success response

### Get Master Room By Id : GET /api/v1/masterRoom/get/:id

**Required fields:**

- Hotel Id (in req.params.id)
- Only super admin can see inactive or deleted master rooms

### Delete Master Room By Ids : DELETE /api/v1/masterRoom/delete/:ids

**Required fields:**

- Master Room Ids (in req.params.ids)
- Can select multiple ids to delete multiple master rooms
- Only super admin can delete master rooms

### Update Master Room By Id : PUT /api/v1/masterRoom/update/:id

**Required fields:**

```
const { masterRoomName, fullDayPrice, description, images, capacity, amenities, isActive, isDeleted } = req.body;
```

- Master Room Id (in req.params.id)

**Process:**

- Only admin can update deleted or inactive master rooms
- Clear undefined values from payload
- Update master room
- Send success response

### Get All Master Room : GET /api/v1/masterRoom/getAll

**Required fields:**

```
const { search = "", hotelId, minPrice, maxPrice, capacity } = req.query;
const page = parseInt(req.query.page) || 1;
const limit = parseInt(req.query.limit);
```

**Process:**

- Search can be possible with multiple hotel ids
- Filter by price range and capacity
- Only super admin can see inactive and deleted master rooms

## Sub Room Module

### Create Sub Room: POST /api/v1/subRoom/create

**Required fields:**

```
const { masterRoomId, name, description, roomNumber, status, isActive } = req.body;
```

**Process:**

- Check if sub room already exists in master room with same name or room number
- Create sub room
- Send success response

### Get Sub Room By Id : GET /api/v1/subRoom/get/:id

**Required fields:**

- Sub Room Id (in req.params.id)
- Only super admin can see inactive or deleted sub rooms

### Delete Sub Room By Ids : DELETE /api/v1/subRoom/delete/:ids

**Required fields:**

- Sub Room Ids (in req.params.ids)
- Can select multiple ids to delete multiple sub rooms
- Only super admin can delete sub rooms

### Update Sub Room By Id : PUT /api/v1/subRoom/update/:id

**Required fields:**

```
const { name, description, roomNumber, status, isActive, isDeleted } = req.body;
```

- Sub Room Id (in req.params.id)

**Process:**

- Only admin can update deleted or inactive sub rooms
- Clear undefined values from payload
- Update sub room
- Send success response

### Get All Sub Rooms : GET /api/v1/subRoom/getAll

**Required fields:**

```
const { search = "", masterRoomId, status } = req.query;
const page = parseInt(req.query.page) || 1;
const limit = parseInt(req.query.limit);
```

**Process:**

- Search can be possible with multiple master room ids
- Filter by status (available, occupied, maintenance)
- Only super admin can see inactive and deleted sub rooms

## Booking Module

### Create Booking: POST /api/v1/booking/create

**Required fields:**

```
const {
  customerId,
  hotelId,
  masterRoomId,
  subRoomId,
  checkInDate,
  checkOutDate,
  totalAmount,
  paymentStatus,
  paymentMethod,
  specialRequests,
  numberOfGuests
} = req.body;
```

**Process:**

- Validate dates (check-in must be before check-out)
- Check room availability for the requested period
- Calculate total amount based on room price and stay duration
- Create booking record
- Update room status
- Send confirmation email/notification
- Send success response with booking details

### Get Booking By Id : GET /api/v1/booking/get/:id

**Required fields:**

- Booking Id (in req.params.id)
- Only related customer, hotel admin/manager or super admin can view booking

### Update Booking By Id : PUT /api/v1/booking/update/:id

**Required fields:**

```
const {
  checkInDate,
  checkOutDate,
  totalAmount,
  paymentStatus,
  specialRequests,
  status,
  isActive,
  isDeleted
} = req.body;
```

- Booking Id (in req.params.id)

**Process:**

- Validate if booking can be updated (not in past, not canceled)
- If dates changed, check room availability
- Recalculate amount if necessary
- Update booking record
- Send notification of booking changes
- Send success response

### Delete Booking By Id : DELETE /api/v1/booking/delete/:id

**Required fields:**

- Booking Id (in req.params.id)
- Only super admin can delete booking records

### Request Booking Cancellation : POST /api/v1/booking/requestBookingCancellation/:bookingId

**Required fields:**

- Booking Id (in req.params.bookingId)
- Reason for cancellation in request body

**Process:**

- Check if booking exists and is not already canceled
- Update booking status to "cancellation requested"
- Record cancellation reason
- Notify hotel admin/manager
- Send success response

### Respond To Cancellation Request : POST /api/v1/booking/respondToCancellationRequest/:bookingId

**Required fields:**

```
const { approved, refundAmount, remarks } = req.body;
```

- Booking Id (in req.params.bookingId)

**Process:**

- Check if cancellation request exists
- If approved, update booking status to "canceled"
- Process refund if applicable
- If rejected, revert booking status to original
- Send notification to customer
- Send success response

### Get All Bookings : GET /api/v1/booking/getAll

**Required fields:**

```
const {
  search = "",
  hotelId,
  customerId,
  status,
  startDate,
  endDate,
  paymentStatus
} = req.query;
const page = parseInt(req.query.page) || 1;
const limit = parseInt(req.query.limit);
```

**Process:**

- Filter by multiple parameters
- Customers can only see their own bookings
- Hotel staff can only see bookings for their hotel
- Super admin can see all bookings
- Only super admin can see deleted bookings
- Apply pagination
- Send response with booking data

## Slot Module

### Create Slot : POST /api/v1/slot/create

**Required fields:**

```
const {
  hotelId,
  masterRoomId,
  date,
  startTime,
  endTime,
  pricePerHour,
  isAvailable,
  maxBookingsAllowed
} = req.body;
```

**Process:**

- Validate time slots (start before end)
- Check for overlapping slots
- Create slot record
- Send success response

### Get All Slots : GET /api/v1/slot/getAll

**Required fields:**

```
const {
  hotelId,
  masterRoomId,
  date,
  isAvailable
} = req.query;
const page = parseInt(req.query.page) || 1;
const limit = parseInt(req.query.limit);
```

**Process:**

- Filter slots by multiple parameters
- Apply pagination
- Send response with slot data

## Payment Module

### Create Payment Intent : POST /api/v1/payment/create-payment-intent

**Required fields:**

```
const {
  bookingId,
  amount,
  currency = "usd",
  paymentMethodType
} = req.body;
```

**Process:**

- Create Stripe payment intent
- Return client secret for frontend to complete payment
- Associate payment intent with booking

### Process Payment Webhook : POST /api/v1/payment/webhook

**Process:**

- Receive webhook from Stripe
- Verify webhook signature
- Update payment status in booking record
- Send confirmation if payment successful
- Send notification to relevant parties

### Get Payment By Id : GET /api/v1/payment/get/:id

**Required fields:**

- Payment Id (in req.params.id)
- Only related customer, hotel staff or super admin can view

### Refund Payment : POST /api/v1/payment/refund

**Required fields:**

```
const {
  paymentId,
  bookingId,
  amount,
  reason
} = req.body;
```

**Process:**

- Validate refund eligibility
- Process refund through Stripe
- Update booking and payment records
- Send notification to customer
- Send success response with refund details
